<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Global Chat | Davinto Tech Hub</title>
  <style>
    body, html { margin:0; padding:0; font-family:'Segoe UI',sans-serif; background:#1e272e; color:#fff; }
    body.dark { background:#fff; color:#111; }
    .toggle { position:fixed; top:10px; right:10px; background:rgba(255,255,255,0.1); padding:6px 12px; border-radius:20px; cursor:pointer; }
    .chat { max-width:800px; margin:80px auto 0; padding:10px; height:400px; overflow-y:auto; background:rgba(0,0,0,0.2); border-radius:8px; }
    .msg { padding:8px; margin:6px 0; background:rgba(255,255,255,0.1); border-radius:6px; }
    .msg.dark { background:rgba(0,0,0,0.1); color:#111; }
    .msg strong { color:#00cec9; }
    .time { font-size:0.8em; color:#ccc; }
    input { width:calc(100% - 90px); padding:10px; border-radius:4px; border:none; }
    button { padding:10px 15px; margin-left:5px; background:#00b894; border:none; border-radius:4px; cursor:pointer; }
    button:hover { background:#019875; }
    .controls { font-size:0.8em; margin-left:10px; color:#0af; cursor:pointer; }
    iframe { position:fixed; bottom:0; left:0; width:100%; height:80px; border:none; pointer-events:none; opacity:0.8; }
    a.back { text-align:center; display:block; margin:10px 0; color:#00cec9; }
  </style>
</head>
<body>

  <div class="toggle" onclick="toggleMode()">üåô Dark Mode</div>

  <div class="chat" id="chat"></div>
  <div style="max-width:800px;margin:20px auto;display:flex;">
    <input type="text" id="msgInput" placeholder="Type your message..." />
    <button onclick="sendMsg()">Send</button>
  </div>
  <a href="homepage.html" class="back">‚Üê Back to Homepage</a>

  <!-- YouTube embed royalty‚Äëfree tech music -->
  <iframe src="https://www.youtube.com/embed/9luV-s_Dk1w?autoplay=1&loop=1&playlist=9luV-s_Dk1w&mute=1" allow="autoplay"></iframe>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
import { getDatabase, ref, push, onChildAdded, update, remove, get, child } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js';

const firebaseConfig = { apiKey:"...", authDomain:"...", projectId:"...", databaseURL:"https://davinto-tech-hub-default-rtdb.firebaseio.com/" };
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser = null, currentUsername = '';

onAuthStateChanged(auth, async user => {
  if (!user) location.href = 'login.html';
  else {
    currentUser = user.uid;
    const snap = await get(child(ref(db), `users/${currentUser}`));
    currentUsername = snap.val()?.username || 'Unknown';
  }
});

const chatEl = document.getElementById('chat');
onChildAdded(ref(db, 'globalChat'), snapshot => {
  const data = snapshot.val();
  const isOwn = data.uid === currentUser;
  const p = document.createElement('div');
  p.className = 'msg' + (document.body.classList.contains('dark')?' dark':'');
  p.id = snapshot.key;
  const timeStr = new Date(data.timestamp).toLocaleString();
  p.innerHTML = `<strong>${data.username}:</strong> ${data.text} <span class="time">${timeStr}</span>`;
  if (isOwn) p.innerHTML += `<span class="controls" onclick="editMsg('${snapshot.key}')">Edit</span><span class="controls" onclick="deleteMsg('${snapshot.key}')">Delete</span>`;
  chatEl.appendChild(p);
  chatEl.scrollTop = chatEl.scrollHeight;
});

window.sendMsg = () => {
  const input = document.getElementById('msgInput');
  const text = input.value.trim();
  if (!text) return;
  push(ref(db, 'globalChat'), { uid:currentUser, username:currentUsername, text, timestamp:Date.now() });
  input.value = '';
};

window.editMsg = async key => {
  const node = document.getElementById(key);
  const newText = prompt('Edit your message:', node.innerText.split(': ')[1].split(' ')[0]);
  if (newText !== null) {
    await update(child(ref(db, 'globalChat'), key), { text:newText });
  }
};

window.deleteMsg = async key => {
  if (confirm('Delete this message?')) {
    await remove(child(ref(db, 'globalChat'), key));
    document.getElementById(key).remove();
  }
};

window.toggleMode = () => {
  document.body.classList.toggle('dark');
  document.querySelector('.toggle').textContent =
    document.body.classList.contains('dark') ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
};
</script>

</body>
</html>